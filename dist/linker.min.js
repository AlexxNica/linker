/*!
 * Linker, Node Editor Library v0.0.1
 * https://github.com/m-reda/linker
 *
 *
 * Released under the MIT license
 *
 * Date: 2017-03-19
 */
!function(t){t.fn.linker=function(e){function n(t,e){var n=document.createElementNS("http://www.w3.org/2000/svg","path");return n.setAttribute("d",o(t.left,t.top,e.left,e.top)),document.getElementById("linker_paths").appendChild(n),n}function o(t,e,n,o){var i=a.offset();t-=i.left,e-=i.top,n-=i.left,o-=i.top;var s=Math.abs(t-n)/2;return e+=5,o+=5," M"+t+","+e+" C"+(t+s)+","+e+" "+(n-s)+","+o+" "+n+","+o+" l-1 0 l-5 -5 m5 5 l-5 5"}function i(){return u++,Math.random().toString(36)+u}var a=t('<div class="linker_board"><svg id="linker_paths"></svg></div>').appendTo(this),s=t.extend({settingIcon:!0},e);t(this).addClass("linker_container"),this.node=function(e){var o=e?e:{x:0,y:0};return o.__id=i(),o.id=o.id?o.id:o.__id,o.el=t('<div class="linker_node node_'+o.id+'" style="left:'+o.x+"px;top: "+o.y+'px;"><h3>'+o.name+' <span class="remove"></span></h3><div class="linker_inputs"></div><div class="linker_outputs"></div></div>'),o.el.data("obj",o),o.paths_out={},o.paths_in={},t("h3 .remove",o.el).click(function(e){confirm("Delete this node?")&&(o.el.remove(),t.each(o.paths_out,function(e,n){t.each(n,function(e,n){t(n[0]).remove()})}),t.each(o.paths_in,function(e,n){t.each(n,function(e,n){t(n[0]).trigger("click",!0)})}),o.onRemove&&o.onRemove())}),o.inputs=[],o.input=function(e,n){var a=o.inputs.push({__id:i(),id:e,node:o,el:t('<div class="linker_point" data-type="input"></div>')}),s=o.inputs[a-1];s.el.data("obj",s),o.paths_in[s.__id]=[];var l=t('<div class="linker_label"><span>'+n+"</span></span></div>").append(s.el);return t(".linker_inputs",o.el).append(l),s},o.outputs=[],o.output=function(e,a){var s=o.outputs.push({__id:i(),id:e,node:o,el:t('<div class="linker_point" data-type="output"></div>')}),l=o.outputs[s-1];l.el.data("obj",l),o.paths_out[l.__id]=[],l.connect=function(e,i){var a=n(this.el.offset(),e.el.offset()),s=[a,this,e];o.paths_out[this.__id].push(s),e.node.paths_in[e.__id].push(s),!i&&this.onConnect&&this.onConnect(e),t(a).on("click",function(n,i){if(i||confirm("Delete this path?")){var a=o.paths_out[l.__id].indexOf(s);o.paths_out[l.__id].splice(a,1),e.node.paths_in[e.__id].splice(1,1),t(this).remove(),l.onRemove&&l.onRemove(a)}})};var c=t('<div class="linker_label"><span>'+a+"</span></div>").append(l.el);return t(".linker_outputs",o.el).append(c),l},s.settingIcon&&t(f).appendTo(t("h3",o.el)).click(function(){o.onSetting&&o.onSetting()}),a.append(o.el),o};var l,c,p=null;a.on("click",function(e){var o=t(e.target),i=o.hasClass("linker_point"),s="output"==o.data("type");if(p){if(i&&!s){var r=p.data("obj"),d=o.data("obj");r.node!=d.node&&r.connect(d)}return p.removeClass("selected"),p=null,t(l).remove(),l=null,void a.removeClass("drag_path")}i&&s&&(p=t(e.target).addClass("selected"),c=p.offset(),l=n(c,c),a.addClass("drag_path"))});var r,d=0;a.on("mousedown",".linker_node > h3",function(e){e.target==this&&(r=t(e.target).parent(),d=r.width()/2)}).on("mouseup",function(t){r=null}).on("mousemove",function(e){if(r){r.offset({top:e.pageY-10,left:e.pageX-d}).trigger("drag");var n=r.data("obj");t.each(n.paths_out,function(e,n){t.each(n,function(e,n){var i=n[1].el.offset(),a=n[2].el.offset();t(n[0]).attr("d",o(i.left,i.top,a.left,a.top))})}),t.each(n.paths_in,function(e,n){t.each(n,function(e,n){var i=n[1].el.offset(),a=n[2].el.offset();t(n[0]).attr("d",o(i.left,i.top,a.left,a.top))})}),n.onDrag&&n.onDrag(parseInt(r.css("left")),parseInt(r.css("top")))}l&&t(l).attr("d",o(c.left,c.top,e.pageX,e.pageY))});var u=Date.now(),f='<svg class="setting" xmlns="http://www.w3.org/2000/svg" version="1.1" viewBox="0 0 54 54" xml:space="preserve"> <path d="M51.22,21h-5.052c-0.812,0-1.481-0.447-1.792-1.197s-0.153-1.54,0.42-2.114l3.572-3.571 c0.525-0.525,0.814-1.224,0.814-1.966c0-0.743-0.289-1.441-0.814-1.967l-4.553-4.553c-1.05-1.05-2.881-1.052-3.933,0l-3.571,3.571 c-0.475,0.475-0.997,0.574-1.352,0.574c-0.5,0-0.997-0.196-1.364-0.539C33.324,8.984,33,8.534,33,7.832V2.78 C33,1.247,31.753,0,30.22,0H23.78C22.247,0,21,1.247,21,2.78v5.052c0,1.218-0.997,1.945-1.961,1.945c-0.354,0-0.876-0.1-1.351-0.574 l-3.571-3.571c-1.052-1.052-2.883-1.05-3.933,0l-4.553,4.553c-0.525,0.525-0.814,1.224-0.814,1.967c0,0.742,0.289,1.44,0.814,1.966 l3.572,3.571c0.573,0.574,0.73,1.364,0.42,2.114S8.644,21,7.832,21H2.78C1.247,21,0,22.247,0,23.78v6.438C0,31.752,1.247,33,2.78,33 h5.052c0.812,0,1.481,0.447,1.792,1.197s0.153,1.54-0.42,2.114l-3.572,3.571c-0.525,0.525-0.814,1.224-0.814,1.966 c0,0.743,0.289,1.441,0.814,1.967l4.553,4.553c1.051,1.051,2.881,1.053,3.933,0l3.571-3.571c0.475-0.475,0.997-0.574,1.352-0.574 c0.963,0,1.96,0.728,1.96,1.945v5.051C21,52.752,22.247,54,23.78,54h6.439c1.533,0,2.78-1.248,2.78-2.781v-5.051 c0-1.218,0.997-1.945,1.96-1.945c0.354,0,0.877,0.1,1.352,0.574l3.571,3.571c1.052,1.052,2.883,1.05,3.933,0l4.553-4.553 c0.525-0.525,0.814-1.224,0.814-1.967c0-0.742-0.289-1.44-0.814-1.966l-3.572-3.571c-0.573-0.574-0.73-1.364-0.42-2.114 S45.356,33,46.168,33h5.052c1.533,0,2.78-1.248,2.78-2.781V23.78C54,22.247,52.753,21,51.22,21z M34,27c0,3.859-3.141,7-7,7 s-7-3.141-7-7s3.141-7,7-7S34,23.141,34,27z"/> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg>';return this}}(jQuery);