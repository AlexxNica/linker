/*!
 * Linker, Node Editor Library v0.0.1
 * https://github.com/m-reda/linker
 *
 *
 * Released under the MIT license
 *
 * Date: 2017-03-19
 */
!function(t){t.fn.linker=function(e){function n(t,e){var n=document.createElementNS("http://www.w3.org/2000/svg","path");return n.setAttribute("d",o(t.left,t.top,e.left,e.top)),document.getElementById("linker_paths").appendChild(n),n}function o(t,e,n,o){var a=i.offset();t-=a.left,e-=a.top,n-=a.left,o-=a.top;var s=Math.abs(t-n)/2;return e+=5,o+=5," M"+t+","+e+" C"+(t+s)+","+e+" "+(n-s)+","+o+" "+n+","+o+" l-1 0 l-5 -5 m5 5 l-5 5"}function a(){return h++,Math.random().toString(36)+h}var i=t('<div class="linker_board"><svg id="linker_paths"></svg></div>').appendTo(this),s=t.extend({settingIcon:!0},e),l=t(this).addClass("linker_container");this.node=function(e){var o=e||{x:0,y:0};return o.__id=a(),o.id=o.id?o.id:o.__id,o.el=t('<div class="linker_node node_'+o.id+'" style="left:'+o.x+"px;top: "+o.y+'px;"><h3>'+o.name+' <span class="remove"></span></h3><div class="linker_inputs"></div><div class="linker_outputs"></div></div>'),o.el.data("obj",o),o.paths_out={},o.paths_in={},t("h3 .remove",o.el).click(function(e){confirm("Delete this node?")&&(o.el.remove(),t.each(o.paths_out,function(e,n){t.each(n,function(e,n){t(n[0]).remove()})}),t.each(o.paths_in,function(e,n){t.each(n,function(e,n){t(n[0]).trigger("click",!0)})}),o.onRemove&&o.onRemove())}),o.inputs=[],o.input=function(e,n){var i=o.inputs.push({__id:a(),id:e,name:n,node:o,el:t('<div class="linker_point" data-type="input"></div>')}),s=o.inputs[i-1];s.el.data("obj",s),o.paths_in[s.__id]=[];var l=t('<div class="linker_label"><span>'+n+"</span></span></div>").append(s.el);return t(".linker_inputs",o.el).append(l),s},o.outputs=[],o.output=function(e,i){var s=o.outputs.push({__id:a(),id:e,name:i,node:o,el:t('<div class="linker_point" data-type="output"></div>')}),l=o.outputs[s-1];l.el.data("obj",l),o.paths_out[l.__id]=[],l.connect=function(e,a){for(var i=o.paths_out[this.__id],s=0;s<i.length;s++)if(e.__id==i[s][2].__id)return;var c=n(this.el.offset(),e.el.offset()),r=[c,this,e];i.push(r),e.node.paths_in[e.__id].push(r),!a&&this.onConnect&&this.onConnect(e),t(c).on("click",function(n,a){if(a||confirm("Delete this path?")){var i=o.paths_out[l.__id].indexOf(r);o.paths_out[l.__id].splice(i,1),e.node.paths_in[e.__id].splice(1,1),t(this).remove(),l.onRemove&&l.onRemove(i)}})};var c=t('<div class="linker_label"><span>'+i+"</span></div>").append(l.el);return t(".linker_outputs",o.el).append(c),l},s.settingIcon&&t(f).appendTo(t("h3",o.el)).click(function(){o.onSetting&&o.onSetting()}),i.append(o.el),o};var c,r,p=null;i.on("click",function(e){var o=t(e.target),a=o.hasClass("linker_point"),s="output"==o.data("type");if(p){if(a&&!s){var l=p.data("obj"),d=o.data("obj");l.node!=d.node&&l.connect(d)}return p.removeClass("selected"),p=null,t(c).remove(),c=null,void i.removeClass("drag_path")}a&&s&&(p=t(e.target).addClass("selected"),r=p.offset(),c=n(r,r),i.addClass("drag_path"))});var d,u=0;i.on("mousedown touchstart",".linker_node > h3",function(e){"touchstart"==e.type&&l.css("overflow","hidden"),e.target==this&&(d=t(e.target).parent(),u=d.width()/2)}).on("mouseup touchend",function(t){if("touchend"==t.type&&l.css("overflow","auto"),d){var e=d.data("obj");e.onDragFinish&&e.onDragFinish(parseInt(d.css("left")),parseInt(d.css("top")))}d=null}).on("mousemove touchmove",function(e){if(d){d.offset({top:e.pageY-10,left:e.pageX-u}).trigger("drag");var n=d.data("obj");t.each(n.paths_out,function(e,n){t.each(n,function(e,n){var a=n[1].el.offset(),i=n[2].el.offset();t(n[0]).attr("d",o(a.left,a.top,i.left,i.top))})}),t.each(n.paths_in,function(e,n){t.each(n,function(e,n){var a=n[1].el.offset(),i=n[2].el.offset();t(n[0]).attr("d",o(a.left,a.top,i.left,i.top))})}),n.onDrag&&n.onDrag(parseInt(d.css("left")),parseInt(d.css("top")))}c&&t(c).attr("d",o(r.left,r.top,e.pageX-5,e.pageY-5))});var h=Date.now(),f='<svg class="setting" xmlns="http://www.w3.org/2000/svg" version="1.1" viewBox="0 0 54 54" xml:space="preserve"> <path d="M51.22,21h-5.052c-0.812,0-1.481-0.447-1.792-1.197s-0.153-1.54,0.42-2.114l3.572-3.571 c0.525-0.525,0.814-1.224,0.814-1.966c0-0.743-0.289-1.441-0.814-1.967l-4.553-4.553c-1.05-1.05-2.881-1.052-3.933,0l-3.571,3.571 c-0.475,0.475-0.997,0.574-1.352,0.574c-0.5,0-0.997-0.196-1.364-0.539C33.324,8.984,33,8.534,33,7.832V2.78 C33,1.247,31.753,0,30.22,0H23.78C22.247,0,21,1.247,21,2.78v5.052c0,1.218-0.997,1.945-1.961,1.945c-0.354,0-0.876-0.1-1.351-0.574 l-3.571-3.571c-1.052-1.052-2.883-1.05-3.933,0l-4.553,4.553c-0.525,0.525-0.814,1.224-0.814,1.967c0,0.742,0.289,1.44,0.814,1.966 l3.572,3.571c0.573,0.574,0.73,1.364,0.42,2.114S8.644,21,7.832,21H2.78C1.247,21,0,22.247,0,23.78v6.438C0,31.752,1.247,33,2.78,33 h5.052c0.812,0,1.481,0.447,1.792,1.197s0.153,1.54-0.42,2.114l-3.572,3.571c-0.525,0.525-0.814,1.224-0.814,1.966 c0,0.743,0.289,1.441,0.814,1.967l4.553,4.553c1.051,1.051,2.881,1.053,3.933,0l3.571-3.571c0.475-0.475,0.997-0.574,1.352-0.574 c0.963,0,1.96,0.728,1.96,1.945v5.051C21,52.752,22.247,54,23.78,54h6.439c1.533,0,2.78-1.248,2.78-2.781v-5.051 c0-1.218,0.997-1.945,1.96-1.945c0.354,0,0.877,0.1,1.352,0.574l3.571,3.571c1.052,1.052,2.883,1.05,3.933,0l4.553-4.553 c0.525-0.525,0.814-1.224,0.814-1.967c0-0.742-0.289-1.44-0.814-1.966l-3.572-3.571c-0.573-0.574-0.73-1.364-0.42-2.114 S45.356,33,46.168,33h5.052c1.533,0,2.78-1.248,2.78-2.781V23.78C54,22.247,52.753,21,51.22,21z M34,27c0,3.859-3.141,7-7,7 s-7-3.141-7-7s3.141-7,7-7S34,23.141,34,27z"/> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg>';return this}}(jQuery);